<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
</head>
<body>
<h1>Welcome to Secure Chat</h1>

<div id="chatSection" style="display: none;">
    <input id="message" type="text" placeholder="Type a message" />
    <button onclick="sendMessage()">Send</button>
    <ul id="messagesList"></ul>
</div>

<script>
    let connection = null;
    let user = null;

    // Retrieve JWT token
    const token = localStorage.getItem("jwtToken");

    if (!token) {
        // Redirect to login if token is missing
        window.location.href = "login.html";
    } else {
        // Extract username from the token
        user = getUserNameFromToken(token);
        if (!user) {
            localStorage.removeItem("jwtToken"); // Invalid token, clear it
            window.location.href = "login.html";
        } else {
            document.getElementById("chatSection").style.display = "block";
            initializeChat(token);
        }
    }

    // Function to initialize the chat
    function initializeChat(token) {
        connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub", {
                accessTokenFactory: () => token
            })
            .withAutomaticReconnect()
            .build();

        connection.start().catch(err => console.error(err));

        // Receive messages from the server and display them
        connection.on("ReceiveMessage", (user, message) => {
            const li = document.createElement("li");
            li.textContent = `${user}: ${message}`;
            document.getElementById("messagesList").appendChild(li);
        });
    }
    
    // Send the message
    function sendMessage() {
        const message = document.getElementById("message").value;

        if (!connection) {
            console.error("Connection not established.");
            return;
        }

        console.log("Sending message:", message);
        console.log("User:", user);
        try{
            connection.invoke("SendMessage", user, message)
        } catch (error) {
            console.error("Error sending message:", error);
        }
        document.getElementById("message").value = ""; // Clear the input field 
    }

    // Function to extract username from JWT
    function getUserNameFromToken(token) {
        try {
            const payload = parseJwt(token) // Decode JWT payload
            console.log("name:", payload.name);
            return payload.name;
        ; // Adjust based on your JWT claims
        } catch (error) {
            console.error("Invalid token", error);
            return null;
        }
    }

    function parseJwt (token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
    }
</script>
</body>
</html>
